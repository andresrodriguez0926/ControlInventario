<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario de Productos y Canastas</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/animations.css">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <link rel="apple-touch-icon" href="img/logo.png">
</head>

<body class="bg-background text-text-primary antialiased h-screen overflow-hidden relative">

    <!-- LOGIN VIEW -->
    <div id="login-wrapper" class="absolute inset-0 z-50 flex items-center justify-center bg-background">
        <div class="surface-card p-8 md:p-10 max-w-sm w-full animate-fade-in shadow-2xl relative overflow-hidden">
            <!-- Decorative accent -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary via-info to-primary"></div>

            <div class="flex flex-col items-center mb-6 mt-2">
                <div class="rounded-full bg-white/5 flex items-center justify-center mb-4 p-2 border border-primary/20 shadow-lg"
                    style="width: 2.92cm; height: 2.44cm;">
                    <img src="img/logo.png" alt="PEDROPI FRUITS s.r.l."
                        class="w-full h-full object-cover drop-shadow-md rounded-full"
                        onerror="this.src=''; this.alt='LOGO AQUÍ'; this.style.fontSize='12px'; this.style.color='#aaa';">
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight text-center leading-tight">PEDROPI<br><span
                        class="text-primary text-xl">FRUITS s.r.l.</span>
                </h1>
                <p class="text-text-secondary text-sm mt-2">Ingresa tus credenciales</p>
            </div>

            <form id="login-form" class="space-y-5">
                <div class="form-group">
                    <label class="form-label text-xs uppercase tracking-wider mb-1">Usuario</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="user" class="w-4 h-4 text-text-muted"></i>
                        </div>
                        <input type="text" id="login-user" class="form-input pl-10" required autocomplete="username"
                            placeholder="admin">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label text-xs uppercase tracking-wider mb-1">Contraseña</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="lock" class="w-4 h-4 text-text-muted"></i>
                        </div>
                        <input type="password" id="login-pass" class="form-input pl-10" required
                            autocomplete="current-password" placeholder="••••••••">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-full mt-2 h-11 relative overflow-hidden group">
                    <span class="relative z-10 flex items-center justify-center gap-2">
                        <span>Iniciar Sesión</span>
                        <i data-lucide="arrow-right" class="w-4 h-4 transition-transform group-hover:translate-x-1"></i>
                    </span>
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP WRAPPER -->
    <div id="app-wrapper"
        class="w-full h-full flex flex-col md:flex-row hidden opacity-0 transition-opacity duration-500">

        <!-- Sidebar Navigation -->
        <aside id="sidebar"
            class="bg-surface sidebar-mobile transition-transform duration-300 md:relative md:translate-x-0 w-64 h-full flex-shrink-0 border-r border-border z-20 absolute flex flex-col">
            <div class="p-4 border-b border-border flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="img/logo.png" alt="Logo" class="object-cover rounded-full bg-white/10 p-0.5"
                        style="width: 2.92cm; height: 2.44cm;"
                        onerror="this.src=''; this.alt='LOGO'; this.style.fontSize='10px'; this.style.color='#aaa';">
                    <h1 class="font-bold text-lg tracking-tight text-white leading-tight">PEDROPI<br><span
                            class="text-primary text-sm uppercase">Fruits</span>
                    </h1>
                </div>
                <button id="close-sidebar" class="md:hidden text-text-secondary hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-3">
                <nav id="main-nav" class="space-y-1">
                    <div class="text-xs font-semibold text-text-secondary mb-2 mt-2 uppercase tracking-wider px-2">
                        Principal
                    </div>
                    <a href="#dashboard"
                        class="nav-item active flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                        Dashboard
                    </a>

                    <a href="#reportes"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="file-bar-chart" class="w-4 h-4"></i>
                        Reportes Diarios
                    </a>

                    <a href="#dashboard-semanal"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        Dashboard Semanal
                    </a>

                    <div class="text-xs font-semibold text-text-secondary mb-2 mt-6 uppercase tracking-wider px-2">
                        Inventario</div>
                    <a href="#recepcion"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="arrow-down-to-line" class="w-4 h-4"></i>
                        Recepción de Mercancía
                    </a>
                    <a href="#despacho-vacias"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="truck" class="w-4 h-4"></i>
                        Despacho Canastas Vacías
                    </a>
                    <a href="#transferencia"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="arrow-right-left" class="w-4 h-4"></i>
                        Transferencia Fincas
                    </a>
                    <a href="#transferencia-interna"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="repeat" class="w-4 h-4"></i>
                        Transferencia Interna
                    </a>
                    <a href="#despacho-cliente"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="package-check" class="w-4 h-4"></i>
                        Despacho a Cliente
                    </a>
                    <a href="#recepcion-canastas"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="archive-restore" class="w-4 h-4"></i>
                        Devolución Canastas
                    </a>
                    <a href="#decomiso"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors text-danger-light hover:text-danger hover:bg-danger/10">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        Decomiso
                    </a>
                    <a href="#canastas-demas"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors text-success-light hover:text-success hover:bg-success/10">
                        <i data-lucide="package-plus" class="w-4 h-4"></i>
                        Canastas de Fruta Demás
                    </a>
                    <a href="#salida-canastas"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors text-danger-light hover:text-danger hover:bg-danger/10">
                        <i data-lucide="archive-x" class="w-4 h-4"></i>
                        Salida de Canastas (Baja)
                    </a>
                    <a href="#compra-canastas"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors text-success-light hover:text-success hover:bg-success/10">
                        <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                        Compra Canastas
                    </a>

                    <div class="text-xs font-semibold text-text-secondary mb-2 mt-6 uppercase tracking-wider px-2">
                        Catálogos
                    </div>
                    <a href="#clientes"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="users-round" class="w-4 h-4"></i>
                        Clientes
                    </a>
                    <a href="#productores"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        Productores
                    </a>
                    <a href="#almacenes"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="warehouse" class="w-4 h-4"></i>
                        Almacenes
                    </a>
                    <a href="#productos"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="apple" class="w-4 h-4"></i>
                        Productos
                    </a>

                    <div class="text-xs font-semibold text-text-secondary mb-2 mt-6 uppercase tracking-wider px-2">
                        Ajustes
                    </div>
                    <a href="#usuarios"
                        class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="users-cog" class="w-4 h-4"></i>
                        Usuarios
                    </a>
                </nav>
            </div>

            <div class="p-4 border-t border-border mt-auto">
                <button id="reset-data"
                    class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-surface-light hover:bg-danger/10 text-text-secondary hover:text-danger transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Limpiar Datos
                </button>
            </div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay"
            class="fixed inset-0 bg-background/80 backdrop-blur-sm z-10 hidden md:hidden transition-opacity opacity-0">
        </div>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col h-full h-screen overflow-hidden relative">
            <!-- Topbar mobile -->
            <header class="md:hidden flex items-center justify-between p-4 border-b border-border bg-surface shrink-0">
                <div class="flex items-center gap-2">
                    <i data-lucide="box" class="text-primary w-5 h-5"></i>
                    <h1 class="font-bold text-lg tracking-tight text-white">Inventario<span
                            class="text-primary">Pro</span>
                    </h1>
                </div>
                <button id="open-sidebar" class="text-text-secondary hover:text-white">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </header>

            <!-- Dynamic User Status Bar (optional extension point) -->
            <div class="hidden md:flex items-center justify-end px-8 py-3 border-b border-border bg-surface shrink-0">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-sm text-text-secondary">
                        <i data-lucide="user" class="w-4 h-4"></i>
                        <span id="current-user-display" class="font-medium text-white">Cargando...</span>
                    </div>
                    <div class="w-px h-4 bg-border"></div>
                    <button id="btn-logout"
                        class="text-text-muted hover:text-danger flex items-center gap-1.5 text-sm transition-colors group">
                        <i data-lucide="log-out" class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform"></i>
                        Salir
                    </button>
                </div>
            </div>

            <!-- Pages Container -->
            <div id="pages-container" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8 bg-background relative">

                <!-- Dashboard Semanal Page -->
                <div id="page-dashboard-semanal" class="page-view hidden animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white">Dashboard Semanal</h2>
                            <p class="text-text-secondary text-sm">Resumen de operaciones y balance de inventario por
                                semana.</p>
                        </div>
                        <div class="flex items-center gap-3 bg-surface-light p-2 rounded-lg border border-border">
                            <label for="sem-semana-selector"
                                class="text-sm font-medium text-text-secondary whitespace-nowrap"><i
                                    data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>Seleccionar Semana:</label>
                            <input type="week" id="sem-semana-selector"
                                class="form-input bg-background/50 border-border text-sm py-1.5 focus:border-primary">
                        </div>
                    </div>

                    <!-- Weekly Balances Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 mt-4">
                        <div class="surface-card p-6 border border-info/20 relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-32 h-32 bg-info/5 rounded-full blur-2xl -mr-10 -mt-10">
                            </div>
                            <div class="flex flex-col h-full">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-info font-bold text-sm tracking-widest uppercase">Inventario
                                        Inicial</span>
                                    <button class="text-info hover:text-white transition-colors"
                                        onclick="window.verDetalleBalanceSemanal('inicial')"
                                        title="Ver detalle del balance">
                                        <i data-lucide="eye" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <span class="text-text-secondary text-xs mb-4">Al comienzo de la semana
                                    seleccionada</span>
                                <div class="grid grid-cols-2 gap-4 mt-2 flex-grow">
                                    <div>
                                        <p class="text-text-muted text-xs uppercase text-center md:text-left">Can.
                                            Llenas</p>
                                        <p class="text-2xl font-bold text-white text-center md:text-left"
                                            id="sem-inicial-llenas">0</p>
                                    </div>
                                    <div>
                                        <p class="text-text-muted text-xs uppercase text-center md:text-left">Can.
                                            Vacías</p>
                                        <p class="text-2xl font-bold text-white text-center md:text-left"
                                            id="sem-inicial-vacias">0</p>
                                    </div>
                                    <div>
                                        <p class="text-text-muted text-xs uppercase text-center md:text-left">Desp.
                                            Productor</p>
                                        <p class="text-2xl font-bold text-warning text-center md:text-left"
                                            id="sem-inicial-desp-prod">0</p>
                                    </div>
                                    <div>
                                        <p class="text-text-muted text-xs uppercase text-center md:text-left">Desp.
                                            Cliente</p>
                                        <p class="text-2xl font-bold text-warning text-center md:text-left"
                                            id="sem-inicial-desp-cli">0</p>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-info/30 flex justify-between items-center px-2">
                                    <span class="text-white font-bold uppercase tracking-wider">TOTAL</span>
                                    <span class="text-3xl font-black text-info" id="sem-inicial-total">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="surface-card p-6 border border-primary/20 relative overflow-hidden flex flex-col">
                            <div
                                class="absolute right-0 top-0 w-32 h-32 bg-primary/5 rounded-full blur-2xl -mr-10 -mt-10">
                            </div>
                            <div class="flex flex-col h-full">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-primary font-bold text-sm tracking-widest uppercase">Inventario
                                        Final</span>
                                    <button class="text-primary hover:text-white transition-colors"
                                        onclick="window.verDetalleBalanceSemanal('final')"
                                        title="Ver detalle del balance">
                                        <i data-lucide="eye" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <span class="text-text-secondary text-xs mb-4">Al terminar la semana seleccionada</span>
                                <div class="grid grid-cols-2 gap-4 mt-2 flex-grow">
                                    <div>
                                        <p class="text-text-muted text-xs uppercase text-center md:text-left">Can.
                                            Llenas</p>
                                        <p class="text-2xl font-bold text-white text-center md:text-left"
                                            id="sem-final-llenas">0</p>
                                    </div>
                                    <div>
                                        <p class="text-text-muted text-xs uppercase text-center md:text-left">Can.
                                            Vacías</p>
                                        <p class="text-2xl font-bold text-white text-center md:text-left"
                                            id="sem-final-vacias">0</p>
                                    </div>
                                    <div>
                                        <p class="text-text-muted text-xs uppercase text-center md:text-left">Desp.
                                            Productor</p>
                                        <p class="text-2xl font-bold text-warning text-center md:text-left"
                                            id="sem-final-desp-prod">0</p>
                                    </div>
                                    <div>
                                        <p class="text-text-muted text-xs uppercase text-center md:text-left">Desp.
                                            Cliente</p>
                                        <p class="text-2xl font-bold text-warning text-center md:text-left"
                                            id="sem-final-desp-cli">0</p>
                                    </div>
                                </div>
                                <!-- Total Bar -->
                                <div
                                    class="mt-4 pt-3 border-t border-primary/30 flex justify-between items-center px-2">
                                    <span class="text-white font-bold uppercase tracking-wider">TOTAL</span>
                                    <span class="text-3xl font-black text-primary" id="sem-final-total">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 gap-6 mb-8">
                        <div class="surface-card p-6 flex flex-col h-[500px]">
                            <h3 class="text-lg font-semibold text-white mb-2">Despacho Diario (Semana)</h3>
                            <p class="text-text-secondary text-sm mb-4">Detalle de canastas llenas enviadas a clientes,
                                agrupado por día.</p>
                            <div id="sem-despacho-diario-container"
                                class="flex-1 min-h-0 overflow-y-auto space-y-6 custom-scrollbar pr-2">
                                <!-- Pivot tables injected via charts.js -->
                            </div>
                        </div>
                    </div>

                    <!-- Canastas por Cobrar -->
                    <div class="surface-card p-5 mb-8 border border-warning/20 relative z-50">
                        <!-- BG shape container (to apply overflow hidden only to the background) -->
                        <div class="absolute inset-0 overflow-hidden pointer-events-none rounded-2xl">
                            <div
                                class="absolute right-0 top-0 w-32 h-32 bg-warning/5 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none">
                            </div>
                        </div>

                        <div
                            class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 relative z-10">
                            <div>
                                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                    <i data-lucide="wallet" class="w-6 h-6 text-warning"></i>
                                    Canastas por Cobrar a Productor
                                </h3>
                                <p class="text-text-secondary text-sm">Historial de movimientos y saldo acumulado por
                                    productor.</p>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-6 mb-6 relative z-30 items-start">
                            <div class="flex-1 w-full form-group relative z-30">
                                <label class="form-label mb-2 font-medium">Seleccionar Productor</label>
                                <select id="canastas-cobrar-productor"
                                    class="form-select text-lg py-2 border-warning/30 bg-surface-light focus:border-warning">
                                    <option value="" disabled selected>-- Elija un productor --</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>

                            <div
                                class="w-full md:w-64 shrink-0 bg-warning/10 border border-warning/30 rounded-xl p-4 flex flex-col justify-center items-center text-center shadow-inner relative z-10">
                                <span class="text-warning text-xs font-bold uppercase tracking-widest mb-1">Balance
                                    Acumulado</span>
                                <span class="text-4xl font-black text-white" id="canastas-cobrar-balance">0</span>
                                <span class="text-text-muted text-xs mt-1">canastas por recuperar</span>
                            </div>
                        </div>

                        <div class="overflow-x-auto border border-border rounded-lg bg-surface relative z-10">
                            <table class="w-full text-left">
                                <thead>
                                    <tr
                                        class="bg-surface-light text-text-secondary text-xs uppercase tracking-wider border-b border-border shadow-sm">
                                        <th class="py-3 px-4 font-semibold w-36">Fecha</th>
                                        <th class="py-3 px-4 font-semibold w-40">Operación</th>
                                        <th class="py-3 px-4 font-semibold">Detalle</th>
                                        <th class="py-3 px-4 font-semibold text-right w-24">Impacto</th>
                                    </tr>
                                </thead>
                                <tbody id="canastas-cobrar-tbody">
                                    <tr>
                                        <td colspan="4"
                                            class="py-12 text-center text-text-secondary italic flex flex-col items-center justify-center">
                                            <i data-lucide="users" class="w-8 h-8 opacity-30 mb-2"></i>
                                            Seleccione un productor para ver sus movimientos.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Reporte de Movimientos de Inventario -->
                    <div class="surface-card p-6 mb-8 mt-2">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                            <div>
                                <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                                    <i data-lucide="file-text" class="w-5 h-5 text-primary"></i>
                                    Reporte de Movimientos a Inventario
                                </h3>
                                <p class="text-text-secondary text-sm">Transacciones y detalle de movimientos por
                                    almacén en un rango de fechas.</p>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 mb-6 items-end">
                            <div class="form-group flex-1">
                                <label class="form-label mb-1">Almacén (Inventario) requerído</label>
                                <select id="rep-inv-almacen" class="form-select text-sm border-primary/30 text-white">
                                    <option value="">-- Seleccionar Almacén --</option>
                                </select>
                            </div>
                            <div class="form-group flex-1 border-l border-border pl-4">
                                <label class="form-label mb-1">Producto (Opcional)</label>
                                <select id="rep-inv-producto" class="form-select text-sm">
                                    <option value="">-- Todos --</option>
                                </select>
                            </div>
                            <div class="form-group border-l border-border pl-4">
                                <label class="form-label mb-1 text-sm">Desde</label>
                                <input type="date" id="rep-inv-desde" class="form-input text-sm">
                            </div>
                            <div class="form-group">
                                <label class="form-label mb-1 text-sm">Hasta</label>
                                <input type="date" id="rep-inv-hasta" class="form-input text-sm">
                            </div>
                            <div class="form-group">
                                <button type="button" id="btn-rep-inv-buscar"
                                    class="btn btn-primary text-sm h-[38px] px-6 flex items-center justify-center">
                                    <i data-lucide="search" class="w-4 h-4 mr-2"></i> Buscar Movimientos
                                </button>
                            </div>
                        </div>

                        <!-- Resultados -->
                        <div class="overflow-x-auto border border-border rounded-lg bg-surface">
                            <table class="w-full text-left">
                                <thead>
                                    <tr
                                        class="bg-surface-light text-text-secondary text-xs uppercase tracking-wider border-b border-border shadow-sm">
                                        <th class="py-3 px-4 font-semibold w-36">Fecha y Hora</th>
                                        <th class="py-3 px-4 font-semibold w-24">Doc #</th>
                                        <th class="py-3 px-4 font-semibold w-40">Operación</th>
                                        <th class="py-3 px-4 font-semibold">Detalle del Movimiento</th>
                                        <th class="py-3 px-4 font-semibold text-right w-24">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody id="rep-inv-tbody">
                                    <tr>
                                        <td colspan="5"
                                            class="py-12 text-center text-text-secondary italic flex flex-col items-center justify-center">
                                            <i data-lucide="inbox" class="w-8 h-8 opacity-30 mb-2"></i>
                                            Seleccione un almacén y rango de fechas, luego presione <b>Buscar
                                                Movimientos</b>.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-view active animate-fade-in">
                    <h2 class="text-2xl font-bold mb-6 text-white">Resumen General</h2>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-4 mb-8">
                        <div class="stat-card">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-text-secondary text-sm font-medium uppercase tracking-wide">Total
                                        Productos</p>
                                    <h3 class="text-3xl font-bold text-white mt-1" id="stat-total-products">0</h3>
                                </div>
                                <div class="p-2 bg-primary/10 rounded-lg">
                                    <i data-lucide="apple" class="w-5 h-5 text-primary"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-text-secondary text-sm font-medium uppercase tracking-wide">Canastas
                                        Llenas</p>
                                    <h3 class="text-3xl font-bold text-success mt-1" id="stat-full-baskets">0</h3>
                                </div>
                                <div class="p-2 bg-success/10 rounded-lg">
                                    <i data-lucide="package" class="w-5 h-5 text-success"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-text-secondary text-sm font-medium uppercase tracking-wide">Canastas
                                        Vacías</p>
                                    <h3 class="text-3xl font-bold text-warning mt-1" id="stat-empty-baskets">0</h3>
                                </div>
                                <div class="p-2 bg-warning/10 rounded-lg">
                                    <i data-lucide="box" class="w-5 h-5 text-warning"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-text-secondary text-sm font-medium uppercase tracking-wide">Almacenes
                                    </p>
                                    <h3 class="text-3xl font-bold text-white mt-1" id="stat-warehouses">0</h3>
                                </div>
                                <div class="p-2 bg-info/10 rounded-lg">
                                    <i data-lucide="warehouse" class="w-5 h-5 text-info"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-text-secondary text-sm font-medium uppercase tracking-wide">Desp.
                                        Productor</p>
                                    <h3 class="text-3xl font-bold text-white mt-1" id="stat-desp-productor">0</h3>
                                </div>
                                <div class="p-2 bg-purple-500/10 rounded-lg">
                                    <i data-lucide="truck" class="w-5 h-5 text-purple-400"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-text-secondary text-sm font-medium uppercase tracking-wide">Desp.
                                        Cliente
                                    </p>
                                    <h3 class="text-3xl font-bold text-success mt-1" id="stat-desp-cliente">0</h3>
                                </div>
                                <div class="p-2 bg-success/10 rounded-lg">
                                    <i data-lucide="package-check" class="w-5 h-5 text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventario de Frutas (Breakdown) -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4 text-white">Inventario Lleno por Tipo de Fruta</h3>
                        <div id="resumen-frutas-container"
                            class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
                            <!-- Populated via JS -->
                        </div>
                    </div>

                    <!-- Charts Area -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
                        <div class="surface-card p-5 h-80 flex flex-col">
                            <h3 class="text-lg font-semibold mb-4 text-white">Ubicación de Fruta por Almacén</h3>
                            <div class="relative flex-1 w-full h-full">
                                <canvas id="warehouseChart"></canvas>
                            </div>
                        </div>
                        <div class="surface-card p-5 h-80 flex flex-col">
                            <h3 class="text-lg font-semibold mb-4 text-white">Estado de Canastas</h3>
                            <div class="relative flex-1 w-full h-full flex justify-center">
                                <canvas id="basketStatusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="surface-card p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Actividad Reciente</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="border-b border-border text-text-secondary text-sm">
                                        <th class="py-3 px-4 font-medium">Fecha</th>
                                        <th class="py-3 px-4 font-medium">Operación</th>
                                        <th class="py-3 px-4 font-medium">Detalle</th>
                                        <th class="py-3 px-4 font-medium">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-activity-table">
                                    <!-- Populated by JS -->
                                    <tr>
                                        <td colspan="4" class="py-8 text-center text-text-secondary">No hay actividad
                                            reciente</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Top Deudores -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                        <div class="surface-card p-5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white">Productores con más Canastas</h3>
                                <i data-lucide="users" class="w-5 h-5 text-warning"></i>
                            </div>
                            <div class="space-y-4" id="top-productores-list">
                                <p class="text-sm text-text-secondary">Cargando...</p>
                            </div>
                        </div>

                        <div class="surface-card p-5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-white">Clientes con más Canastas</h3>
                                <i data-lucide="users-round" class="w-5 h-5 text-warning"></i>
                            </div>
                            <div class="space-y-4" id="top-clientes-list">
                                <p class="text-sm text-text-secondary">Cargando...</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Formularios generados dinámicamente -->
                <div id="dynamic-pages-container"></div>

            </div>
    </div>
    </main>
    </div> <!-- END APP WRAPPER -->

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Modal Editar Recepción (Admin Only) -->
    <div id="modal-editar-recepcion"
        class="fixed inset-0 bg-background/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden border border-border">
            <div class="p-4 border-b border-border bg-surface-light flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="edit-3" class="w-5 h-5 text-primary"></i>
                    Modificar Recepción Existente
                </h3>
                <button type="button"
                    onclick="document.getElementById('modal-editar-recepcion').classList.add('hidden')"
                    class="text-text-muted hover:text-danger transition-colors p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-6">
                <div class="bg-primary/10 border border-primary/20 rounded-lg p-4 mb-6 flex gap-3">
                    <i data-lucide="info" class="w-5 h-5 text-primary shrink-0"></i>
                    <p class="text-sm text-text-secondary">Modificar esta recepción recalculará automáticamente el
                        inventario del almacén y las deudas del productor. Asegúrese de ingresar los datos correctos.
                    </p>
                </div>

                <form id="form-editar-recepcion" class="space-y-4">
                    <input type="hidden" id="edit-rec-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label mb-1">Nueva Fecha</label>
                            <input type="date" id="edit-rec-fecha" class="form-input text-sm" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label mb-1">Productor</label>
                            <select id="edit-rec-productor" class="form-select text-sm" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label mb-1">Persona que Entregó</label>
                            <input type="text" id="edit-rec-entrega" class="form-input text-sm" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label mb-1">Persona que Recibió</label>
                            <input type="text" id="edit-rec-recibe" class="form-input text-sm" required>
                        </div>
                    </div>

                    <div class="form-group md:col-span-2 mt-2">
                        <button type="button" id="btn-add-edit-rec-lote"
                            class="btn btn-primary w-full py-2 text-sm font-bold flex items-center justify-center gap-2 hover:opacity-90 transition-opacity uppercase shadow-lg shadow-primary/20">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Añadir Mercancía
                        </button>
                    </div>

                    <div class="form-group md:col-span-2 mb-2">
                        <div class="overflow-x-auto rounded-lg border border-border">
                            <table class="w-full text-left bg-surface" id="tabla-edit-rec-lotes">
                                <thead>
                                    <tr
                                        class="bg-surface-light text-text-secondary text-xs uppercase border-b border-border">
                                        <th class="p-3 font-semibold">Producto</th>
                                        <th class="p-3 font-semibold w-40">Cantidad Canasta</th>
                                        <th class="p-3 font-semibold">Almacén de Destino</th>
                                        <th class="p-3 font-semibold w-16 text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows injected by app.js when editing -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button"
                            onclick="document.getElementById('modal-editar-recepcion').classList.add('hidden')"
                            class="btn btn-secondary px-6">Cancelar</button>
                        <button type="submit" class="btn btn-primary px-8">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Ver Documento (Solo Lectura) -->
    <div id="modal-ver-documento"
        class="fixed inset-0 bg-background/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden border border-border">
            <div class="p-4 border-b border-border bg-surface-light flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-primary"></i>
                    Detalles del Documento
                </h3>
                <button type="button" onclick="document.getElementById('modal-ver-documento').classList.add('hidden')"
                    class="text-text-muted hover:text-danger transition-colors p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="inline-block px-4 py-1 rounded-full bg-primary/10 border border-primary/20 text-primary font-mono text-xl font-bold tracking-wider mb-2"
                        id="doc-view-numero">DOC-0000</div>
                    <p class="text-text-secondary text-sm" id="doc-view-fecha">01/01/2026 12:00:00</p>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center pb-3 border-b border-border/50">
                        <span class="text-text-muted text-sm uppercase tracking-wider font-semibold">Operación</span>
                        <span class="text-white font-medium bg-surface-light px-2 py-1 rounded text-sm"
                            id="doc-view-operacion">Cargando...</span>
                    </div>

                    <div id="doc-view-dinamico" class="space-y-3">
                        <!-- Technical Details auto-injected here -->
                    </div>

                    <div class="flex flex-col pt-3 border-t border-border mt-4">
                        <span class="text-text-muted text-sm uppercase tracking-wider font-semibold mb-1">Resumen del
                            Movimiento</span>
                        <span class="text-white text-lg font-bold" id="doc-view-cantidad">0</span>
                    </div>
                </div>

                <div class="flex justify-center mt-8">
                    <button type="button"
                        onclick="document.getElementById('modal-ver-documento').classList.add('hidden')"
                        class="btn btn-secondary px-8 w-full border border-border hover:bg-surface-light">Cerrar
                        Visualización</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Despacho Vacías (Admin Only) -->
    <div id="modal-editar-despacho-vacias"
        class="fixed inset-0 bg-background/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden border border-border">
            <div class="p-4 border-b border-border bg-surface-light flex justify-between items-center">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="edit-3" class="w-5 h-5 text-warning"></i>
                    Modificar Despacho de Vacías
                </h3>
                <button type="button"
                    onclick="document.getElementById('modal-editar-despacho-vacias').classList.add('hidden')"
                    class="text-text-muted hover:text-danger transition-colors p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-6">
                <div class="bg-warning/10 border border-warning/20 rounded-lg p-4 mb-6 flex gap-3">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-warning shrink-0"></i>
                    <p class="text-sm text-text-secondary">Modificar este despacho recalculará las canastas vacías en el
                        almacén y la deuda del productor seleccionado.</p>
                </div>

                <form id="form-editar-despacho-vacias" class="space-y-4">
                    <input type="hidden" id="edit-vac-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label mb-1">Nueva Fecha</label>
                            <input type="date" id="edit-vac-fecha" class="form-input text-sm" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label mb-1">Productor Destino</label>
                            <select id="edit-vac-productor" class="form-select text-sm" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label mb-1">Almacén de Orígen</label>
                            <select id="edit-vac-almacen" class="form-select text-sm" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label mb-1">Persona que Retira</label>
                            <input type="text" id="edit-vac-retira" class="form-input text-sm" required>
                        </div>
                    </div>

                    <div class="form-group pt-4 border-t border-border mt-4">
                        <label class="form-label mb-1 font-bold text-warning">Cantidad Corregida de Vacías</label>
                        <input type="number" id="edit-vac-cantidad"
                            class="form-input text-xl py-3 border-warning/30 text-warning focus:border-warning" min="1"
                            required>
                    </div>

                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button"
                            onclick="document.getElementById('modal-editar-despacho-vacias').classList.add('hidden')"
                            class="btn btn-secondary px-6">Cancelar</button>
                        <button type="submit" class="btn btn-primary px-8"
                            style="background-color: var(--accent-warning); border-color: var(--accent-warning); color: #000">Guardar
                            Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Balance Semanal -->
    <div id="modal-detalle-balance"
        class="fixed inset-0 bg-background/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-surface rounded-2xl w-full max-w-xl shadow-2xl overflow-hidden border border-border flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-border bg-surface-light flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold text-white flex items-center gap-2" id="detalle-balance-titulo">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 text-primary"></i>
                    Detalle de Balance
                </h3>
                <button type="button" onclick="document.getElementById('modal-detalle-balance').classList.add('hidden')"
                    class="text-text-muted hover:text-danger transition-colors p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <div class="space-y-6">
                    <!-- Canastas Llenas -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-bold uppercase tracking-widest text-[#10b981]">Canastas Llenas</h4>
                            <span class="text-lg font-black text-white" id="db-total-llenas">0</span>
                        </div>
                        <div id="db-lista-llenas"
                            class="bg-surface-light rounded p-3 text-sm text-text-secondary space-y-1 border border-border/50">
                            <!-- Inyectado por JS -->
                        </div>
                    </div>

                    <!-- Canastas Vacías -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-bold uppercase tracking-widest text-[#f59e0b]">Canastas Vacías</h4>
                            <span class="text-lg font-black text-white" id="db-total-vacias">0</span>
                        </div>
                        <div id="db-lista-vacias"
                            class="bg-surface-light rounded p-3 text-sm text-text-secondary space-y-1 border border-border/50">
                            <!-- Inyectado por JS -->
                        </div>
                    </div>

                    <!-- Deudas (Despachos) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-xs font-bold uppercase tracking-widest text-warning">A Productores</h4>
                                <span class="text-md font-black text-white" id="db-total-dprod">0</span>
                            </div>
                            <div id="db-lista-dprod"
                                class="bg-surface-light rounded p-3 text-xs text-text-secondary border border-border/50 max-h-40 overflow-y-auto custom-scrollbar">
                                <!-- Inyectado por JS -->
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-xs font-bold uppercase tracking-widest text-warning">A Clientes</h4>
                                <span class="text-md font-black text-white" id="db-total-dcli">0</span>
                            </div>
                            <div id="db-lista-dcli"
                                class="bg-surface-light rounded p-3 text-xs text-text-secondary border border-border/50 max-h-40 overflow-y-auto custom-scrollbar">
                                <!-- Inyectado por JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-border bg-surface shrink-0 flex justify-end gap-3">
                <button type="button" onclick="window.compartirDetalleBalanceWhatsApp()"
                    class="btn btn-primary px-4 border-none text-white flex items-center gap-2"
                    style="background-color: #25D366;" id="btn-compartir-balance-wa">
                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                    Compartir
                </button>
                <button type="button" onclick="document.getElementById('modal-detalle-balance').classList.add('hidden')"
                    class="btn btn-secondary px-6">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Firebase Compat v8 -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <!-- Scripts de la App -->
    <script src="js/store.js?v=7"></script>
    <script src="js/ui.js?v=7"></script>
    <script src="js/charts.js?v=7"></script>
    <script src="js/modules/catalogos.js?v=7"></script>
    <script src="js/modules/operaciones.js?v=7"></script>
    <script src="js/modules/operaciones2.js?v=7"></script>
    <script src="js/modules/usuarios.js?v=7"></script>
    <script src="js/modules/reportes.js?v=7"></script>
    <script src="js/app.js?v=7"></script>

    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>